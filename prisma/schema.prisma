// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  avatarUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  events    Event[]
  dashboard DashboardData[]
  cashflows Cashflow[]
  cashflowGroups CashflowGroup[]
  // Stocks
  watchlists Watchlist[]
  portfolios Portfolio[]
  stockTransactions StockTransaction[]
}

model Event {
  id        String   @id @default(uuid())
  title     String
  date      DateTime
  userId    String
  user      User     @relation(fields: [userId], references: [id])
}

model DashboardData {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  metric    String
  value     Float
}

model Cashflow {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  data            DateTime
  tipo            String   // "Receita" ou "Despesa"
  categoria       String
  descricao       String
  valor           Float
  forma_pagamento String
  pago            Boolean
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model CashflowGroup {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  name      String
  type      String   // "Entradas" or "Despesas" - explicitly track the type
  parentId  String?  // Para subgrupos
  parent    CashflowGroup? @relation("ParentGroup", fields: [parentId], references: [id])
  children  CashflowGroup[] @relation("ParentGroup")
  items     CashflowItem[]
  order     Int
  percentTotal Float? // Percentual do grupo
  observacoes String? // Observações/comentários
  isActive  Boolean  @default(true) // Status ativo/inativo
}

model CashflowItem {
  id            String   @id @default(uuid())
  groupId       String
  group         CashflowGroup @relation(fields: [groupId], references: [id])
  descricao     String
  significado   String?
  rank          Int?
  percentTotal  Float?
  valores       CashflowValue[]
  order         Int
  categoria     String? // Categoria do item
  formaPagamento String? // Forma de pagamento
  status        String? // Status: 'pago', 'pendente', 'recebido'
  dataVencimento DateTime? // Data de vencimento
  observacoes   String? // Observações/comentários
  isActive      Boolean @default(true) // Status ativo/inativo
  isInvestment  Boolean @default(false) // Se é um item de investimento
}

model CashflowValue {
  id        String   @id @default(uuid())
  itemId    String
  item      CashflowItem @relation(fields: [itemId], references: [id])
  mes       Int      // 0 = Jan, 11 = Dez
  valor     Float
  dataPagamento DateTime? // Data efetiva do pagamento
  status    String? // Status específico do mês: 'pago', 'pendente', 'recebido'
  observacoes String? // Observações do mês
}

// ===== STOCKS MODULE =====

// Ativo/Stock disponível na B3
model Stock {
  id          String   @id @default(uuid())
  ticker      String   @unique // Código do ativo (ex: PETR4, VALE3)
  companyName String   // Nome da empresa
  sector      String?  // Setor da empresa
  subsector   String?  // Subsetor
  segment     String?  // Segmento
  isActive    Boolean  @default(true)
  lastUpdate  DateTime @default(now())
  
  // Relacionamentos
  watchlists Watchlist[]
  portfolios Portfolio[]
  transactions StockTransaction[]
  
  @@map("stocks")
}

// Lista de observação do usuário
model Watchlist {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  stockId   String
  stock     Stock    @relation(fields: [stockId], references: [id])
  addedAt   DateTime @default(now())
  notes     String?  // Observações do usuário
  
  @@unique([userId, stockId])
  @@map("watchlists")
}

// Portfolio do usuário (ações que possui)
model Portfolio {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  stockId   String
  stock     Stock    @relation(fields: [stockId], references: [id])
  quantity  Int      // Quantidade de ações
  avgPrice  Float    // Preço médio de compra
  totalInvested Float // Total investido
  lastUpdate DateTime @default(now())
  
  @@unique([userId, stockId])
  @@map("portfolios")
}

// Histórico de transações (compras e vendas)
model StockTransaction {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  stockId   String
  stock     Stock    @relation(fields: [stockId], references: [id])
  type      String   // "compra" ou "venda"
  quantity  Int      // Quantidade de ações
  price     Float    // Preço por ação
  total     Float    // Valor total da transação
  date      DateTime // Data da transação
  fees      Float?   // Taxas da operação
  notes     String?  // Observações
  createdAt DateTime @default(now())
  
  @@map("stock_transactions")
}
